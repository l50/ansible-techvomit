---
- name: Clone techvomit repo
  git:
    repo: git://github.com/l50/techvomit.git
    dest: "{{techvomit_directory}}"

- name: Copy creds env file into place
  copy:
    src: env
    dest: "{{techvomit_directory}}/.env"

- name: Get backed up ghost data into place
  shell: "{{aws_cli}} s3 cp s3://{{s3_bucket_name}}/$({{aws_cli}} s3 ls s3://{{s3_bucket_name}} | grep ghost | tail -n 1 | awk '{ print $4 }') {{techvomit_directory}}"

- name: Get backed up MariaDB data into place
  shell: "{{aws_cli}} s3 cp s3://{{s3_bucket_name}}/$({{aws_cli}} s3 ls s3://{{s3_bucket_name}} | grep mariadb | tail -n 1 | awk '{ print $4 }') {{techvomit_directory}}"

- name: Unzip Ghost backup
  shell: "unzip {{ghost_backup_zip}} -d {{ghost_backup}}"

- name: Unzip MariaDB backup
  shell: "unzip {{mariadb_backup_zip}} -d {{mariadb_backup}}"

- name: docker-compose up to get the folder infrastructure built up
  shell: "docker-compose up -d"
  args:
    chdir: "{{techvomit_directory}}"

# TODO: Might be able to shorten this to 4 minutes
- name: Wait until the blog is finished with initial setup
  pause:
    minutes: 6

- name: Stop techvomit containers so we can move data into place
  shell: "docker-compose stop"
  args:
    chdir: "{{techvomit_directory}}"

- name: Rsync MariaDB data
  shell: "rsync -a {{mariadb_backup}}/_data/ {{mariadb_data}}/_data/"

- name: Transfer aio theme
  shell: "cp -r {{aio_backup}} {{ghost_data}}/_data/ghost/content/themes/"

- name: Force rebuild to incorporate the data
  shell: "docker-compose up -d --force-recreate"
  args:
    chdir: "{{techvomit_directory}}"

#- name: Clean up backup data - TODO: needs testing
#  shell: "rm {{techvomit_directory}}/*zip; rm -rf {{techvomit_directory}}/techvomit_*_data"
